// App module Gradle file for a Cordova + GeckoView project

apply plugin: 'com.android.application'

// Allow overriding ABIs/locales via -PGECKO_ABIS="arm64-v8a,armeabi-v7a" etc.
def geckoAbis = (project.findProperty("GECKO_ABIS") ?: "arm64-v8a")
        .split(",")
        .collect { it.trim() }
        .findAll { it && !it.equalsIgnoreCase("all") }
if (geckoAbis.isEmpty()) {
    geckoAbis = ["arm64-v8a"]
}
def resPref = project.findProperty("GECKO_RES_CONFIGS") ?: "en"
def keepAllLocales = resPref.equalsIgnoreCase("all")
def geckoResConfigs = keepAllLocales ? [] : resPref
        .split(",")
        .collect { it.trim() }
        .findAll { it }
def enableMinify = (project.findProperty("GECKO_ENABLE_MINIFY") ?: "false")
        .toString()
        .toBoolean()

android {
    // Cordova usually defines these in Gradle properties; if your generated file
    // uses cdvCompileSdkVersion etc., you can keep those instead of hardcoding.

    defaultConfig {

        // Only ship the requested ABIs (defaults to arm64 for smallest Gecko build)
        ndk {
            abiFilters(*geckoAbis)
        }

        // Strip unused locales from resources packaged into the APK/App Bundle
        if (!geckoResConfigs.isEmpty()) {
            resConfigs(*geckoResConfigs)
        }
    }

    // Required for GeckoView 143+
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }

    // Release vs debug builds
    buildTypes {
        release {
            // Optional code/resource shrinking. Disabled by default since SnakeYAML pulls in java.beans.
            if (enableMinify) {
                minifyEnabled true
                shrinkResources true
                proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'),
                              'proguard-geckoview.pro'
            } else {
                minifyEnabled false
                shrinkResources false
            }
        }
        debug {
            minifyEnabled false
            shrinkResources false
        }
    }

    // Strip debug symbol libraries if present (can be large)
    packagingOptions {
        excludes += ["**/*.so.debug"]
        excludes += ["**/libxul.so.debug"]
    }
}

// Repositories: Cordova + GeckoView
repositories {
    google()
    mavenCentral()
    // Needed for GeckoView dependency
    maven { url "https://maven.mozilla.org/maven2/" }
}

// Dependencies
dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar'])

    // Cordova core library (this project is generated by cordova-android)
    implementation project(':CordovaLib')

    // GeckoView engine (regular, not omni, to keep size down)
    implementation "org.mozilla.geckoview:geckoview:142.0.20240902114345"
}

// Cordova hooks (this line is normally at the end of app/build.gradle)
apply from: "../CordovaLib/cordova.gradle"
